#!/bin/bash

declare bindir
bindir=$(realpath "$(dirname "$0")")
cd "${bindir%/*}" || exit 1

declare -i fails
fails=0

rm -fr build
mkdir -p build || exit 1
cp -r exercises/practice/* build/ || exit 1

for path in build/*; do
    pushd "$path" > /dev/null || exit 1
    solution_file="$(sed -r 's/(^|-)([a-z])/\U\2/g' <<< "${path#*/}").pas"
    echo -n "[EXERCISE] ${path#*/}..."
    jq -M -r '
      .authors | length |
      if . < 1 then
        ("[ERROR] authors not set\n" | halt_error)
      else
        empty
      end
    ' ./.meta/config.json || (( fails += 1 ))
    make_test_stub=$(
        make -B test=all 2>&1 |
            sed -e '1{/^TAP version 14$/d}' \
                -e '2{/^1\.\.[0-9]\+$/d}' \
                -e '3{/^not ok 0 - Please implement your solution.$/d}'
    )
    if [[ "$path" == 'build/hello-world' ]]; then
        if ! grep -q '^not ok 1 - SayHi$' <<< "$make_test_stub"; then
            echo 'stub file fail'
            echo "$make_test_stub"
            (( fails += 1 ))
        else
            echo 'pass'
        fi
    elif [[ "$make_test_stub" != '' ]]; then
        echo 'stub file fail'
        echo "$make_test_stub"
        (( fails += 1 ))
    else
        cp ./.meta/example.pas "$solution_file"
        make_test_example=$(
            make -B test=all 2>&1 |
                sed -e '1{/^TAP version 14$/d}' \
                    -e '2{/^1\.\.[0-9]\+$/d}' \
                    -e '/^ok [0-9]\+ - [0-9A-Za-z_]\+$/d'
            )
        if [[ "$make_test_example" == '' ]]; then
            echo 'pass'
        else
            echo 'fail'
            echo "$make_test_example"
            echo ''
            (( fails += 1 ))
        fi
    fi
    popd > /dev/null || exit 1
done

test $fails -eq 0 || exit 1
